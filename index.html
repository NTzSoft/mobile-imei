<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>สถานะเครื่องมือถือ</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
  <div id="auth-overlay" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
    <div class="text-center">
      <h2 class="mb-4 text-lg font-semibold">กรุณาใส่รหัสผ่านเพื่อเข้าใช้งาน</h2>
      <input type="password" id="password-input" class="border p-2 rounded" placeholder="ใส่รหัสผ่าน" />
      <button onclick="checkPassword()" class="bg-blue-600 text-white px-4 py-2 rounded ml-2">เข้าสู่ระบบ</button>
    </div>
  </div>

  <header class="bg-blue-600 text-white p-4 shadow-md flex justify-between items-center">
    <h1 class="text-xl font-semibold">แสดงสถานะเครื่องมือถือ</h1>
    <a href="https://support.oppo.com/en/warranty-check/" target="_blank" class="bg-white text-blue-600 px-4 py-2 rounded">Warranty Check</a>
  </header>

  <main class="p-6">
    <div class="mb-4 flex gap-2 flex-wrap">
      <button onclick="filterStatus('all')" class="bg-gray-300 hover:bg-gray-400 text-black px-4 py-2 rounded">ทั้งหมด</button>
      <button onclick="filterStatus('Active')" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">ยิงแล้ว</button>
      <button onclick="filterStatus('')" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded">ยังไม่ได้ยิง</button>
      <select id="storeFilter" onchange="filterStore()" class="border rounded px-4 py-2">
        <option value="all">ร้านทั้งหมด</option>
      </select>
    </div>

    <div id="toast" class="fixed bottom-4 right-4 bg-blue-500 text-white px-4 py-2 rounded shadow-md hidden z-50"></div>

    <div id="card-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4"></div>
  </main>

  <!-- Modal -->
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white p-6 rounded shadow-md w-full max-w-md">
      <h2 class="text-lg font-bold mb-4" id="modal-title"></h2>
      <textarea id="note-input" rows="3" class="w-full border rounded p-2 mb-4" placeholder="ระบุหมายเหตุ"></textarea>
      <div class="flex justify-end gap-2">
        <button onclick="closeModal()" class="bg-gray-300 px-4 py-2 rounded">ยกเลิก</button>
        <button onclick="confirmStatusChange()" class="bg-blue-600 text-white px-4 py-2 rounded">ยืนยัน</button>
      </div>
    </div>
  </div>

  <script>
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSVlzVoxxhwFOFIfeQQEkPLbXHjdnyvuYTi6-UQJnldE9txyBc-EQbGKqwDP1j8-6zZoZC8r846lt1Q/pub?output=csv";
    let rawData = [];
    let filteredData = [];
    let changingIndex = null;
    let changingStatus = "";

    function showToast(msg) {
      const toast = document.getElementById("toast");
      toast.innerText = msg;
      toast.classList.remove("hidden");
      setTimeout(() => toast.classList.add("hidden"), 2500);
    }

    function checkPassword() {
      const input = document.getElementById("password-input").value;
      if (input === "424520") {
        document.getElementById("auth-overlay").classList.add("hidden");
      } else {
        alert("รหัสผ่านไม่ถูกต้อง");
      }
    }

    function csvToJson(csv) {
      const lines = csv.trim().split('\n');
      const headers = lines[0].split(',');
      return lines.slice(1).map(line => {
        const values = line.split(',');
        let obj = {};
        headers.forEach((h, i) => obj[h.trim()] = values[i] ? values[i].trim() : '');
        return obj;
      });
    }

    function loadData() {
      fetch(csvUrl)
        .then(res => res.text())
        .then(csv => {
          rawData = csvToJson(csv);
          filteredData = rawData;
          renderCards(filteredData);
          populateStoreFilter();
        })
        .catch(err => alert("โหลดข้อมูลไม่สำเร็จ"));
    }

    function renderCards(data) {
      const container = document.getElementById("card-container");
      container.innerHTML = "";
      data.forEach((row, index) => {
        const cardColor = row["สถานะ"] === "Active" ? "bg-green-100" : "bg-yellow-100";
        const statusText = row["สถานะ"] === "Active" ? "ยิงแล้ว" : "ยังไม่ได้ยิง";
        const card = document.createElement("div");
        card.id = `card-${index}`;
        card.dataset.color = cardColor;
        card.className = `rounded-xl border p-4 shadow-md ${cardColor}`;
        card.innerHTML = `
          <div class="flex justify-between items-start">
            <div>
              <h2 class="text-lg font-bold">${row["รุ่น"] || '-'}</h2>
              <p class="text-sm text-gray-600">${row["สี"] || '-'}</p>
              <p class="text-sm text-gray-600">${row["ร้าน"] || '-'}</p>
              <p class="text-sm text-gray-800">IMEI: ${row["IMEI"] || '-'}</p>
              <p class="text-sm text-gray-800">หมายเหตุ: ${row["หมายเหตุ"] || '-'}</p>
            </div>
            <span class="status-badge inline-block px-2 py-1 text-xs font-semibold rounded-full ${row["สถานะ"] === "Active" ? "bg-green-500 text-white" : "bg-yellow-500 text-black"}">${statusText}</span>
          </div>
          <div class="mt-4 flex justify-between items-center">
            <button onclick="openModal(${index}, '${row["สถานะ"] === "Active" ? "" : "Active"}')" class="text-sm text-white px-2 py-1 rounded ${row["สถานะ"] === "Active" ? "bg-red-500" : "bg-green-500"}">
              ${row["สถานะ"] === "Active" ? "ยกเลิก Active" : "กดเพื่อ Active"}
            </button>
            <button onclick="copyIMEI('${row["IMEI"]}', ${index})" class="text-sm text-white px-2 py-1 rounded bg-blue-500">Copy IMEI</button>
          </div>


        `;
        container.appendChild(card);
      });
    }

    function copyIMEI(imei, index) {
      navigator.clipboard.writeText(imei).then(() => {
        showToast("คัดลอก IMEI แล้ว");
        const card = document.getElementById(`card-${index}`);
        const badge = card.querySelector(".status-badge");
        const originalText = badge.innerText;
        const originalColor = card.dataset.color;

        card.className = "rounded-xl border p-4 shadow-md bg-blue-100";
        badge.innerText = "กำลัง Copy...";

        setTimeout(() => {
          badge.innerText = originalText;
          card.className = `rounded-xl border p-4 shadow-md ${originalColor}`;
        }, 2500);
      });
    }

    function openModal(index, newStatus) {
      changingIndex = index;
      changingStatus = newStatus;
      document.getElementById("note-input").value = newStatus === "Active" ? "Active เอง" : "";
      document.getElementById("modal-title").innerText = `ยืนยันการเปลี่ยนสถานะเป็น ${newStatus || "ยังไม่ Active"}`;
      document.getElementById("modal").classList.remove("hidden");
    }

    function closeModal() {
      document.getElementById("modal").classList.add("hidden");
    }

    function confirmStatusChange() {
      const note = document.getElementById("note-input").value;
      rawData[changingIndex]["สถานะ"] = changingStatus;
      rawData[changingIndex]["หมายเหตุ"] = note;
      renderCards(filteredData);
      closeModal();
    }

    function filterStatus(status) {
      filteredData = status === "all" ? rawData : rawData.filter(r => (r["สถานะ"] || "") === status);
      renderCards(filteredData);
    }

    function populateStoreFilter() {
      const storeSet = new Set(rawData.map(r => r["ร้าน"]));
      const select = document.getElementById("storeFilter");
      storeSet.forEach(store => {
        const opt = document.createElement("option");
        opt.value = store;
        opt.innerText = store;
        select.appendChild(opt);
      });
    }

    function filterStore() {
      const selected = document.getElementById("storeFilter").value;
      const base = selected === "all" ? rawData : rawData.filter(r => r["ร้าน"] === selected);
      filteredData = base;
      renderCards(filteredData);
    }

    loadData();
  </script>
</body>
</html>
