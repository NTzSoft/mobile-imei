<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>สถานะเครื่องมือถือ</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">

  <!-- Auth Screen -->
  <div id="auth-screen" class="fixed inset-0 bg-gray-900 bg-opacity-95 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-lg p-6 max-w-sm w-full">
      <h2 class="text-lg font-semibold mb-4 text-center">กรุณาใส่รหัสผ่านเพื่อเข้าสู่ระบบ</h2>
      <input id="password-input" type="password" placeholder="รหัสผ่าน" class="w-full px-3 py-2 border rounded mb-4 focus:outline-none focus:ring focus:border-blue-300">
      <button onclick="checkPassword()" class="w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">เข้าสู่ระบบ</button>
      <p id="error-msg" class="text-red-500 text-sm mt-2 text-center hidden">รหัสผ่านไม่ถูกต้อง</p>
    </div>
  </div>

  <!-- Main Content -->
  <div id="main-content" style="display: none;">
    <header class="bg-blue-600 text-white p-4 shadow-md flex justify-between items-center">
      <h1 class="text-xl font-semibold">แสดงสถานะเครื่องมือถือ</h1>
      <a href="https://support.oppo.com/en/warranty-check/" target="_blank" class="bg-white text-blue-600 px-4 py-2 rounded hover:bg-blue-100">Warranty Check</a>
    </header>

    <main class="p-4">
      <div class="mb-4 flex gap-2">
        <button onclick="filterStatus('all')" class="bg-gray-300 hover:bg-gray-400 text-black px-4 py-2 rounded">ทั้งหมด</button>
        <button onclick="filterStatus('Active')" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">Active</button>
        <button onclick="filterStatus('')" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded">ยังไม่ Active</button>
      </div>

      <div id="alert-box" class="fixed bottom-4 right-4 bg-blue-600 text-white px-4 py-2 rounded shadow hidden z-40">
        Copy IMEI แล้ว
      </div>

      <div id="card-container" class="grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3"></div>
    </main>

    <!-- Modal -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
      <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md">
        <h2 class="text-lg font-semibold mb-4" id="modal-title">ยืนยันการเปลี่ยนสถานะ</h2>
        <input type="text" id="remark-input" class="w-full px-3 py-2 border rounded mb-4" placeholder="หมายเหตุ (เช่น Active เอง)">
        <div class="flex justify-end gap-2">
          <button onclick="closeModal()" class="bg-gray-300 px-4 py-2 rounded">ยกเลิก</button>
          <button onclick="confirmStatusChange()" class="bg-blue-600 text-white px-4 py-2 rounded">ยืนยัน</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSVlzVoxxhwFOFIfeQQEkPLbXHjdnyvuYTi6-UQJnldE9txyBc-EQbGKqwDP1j8-6zZoZC8r846lt1Q/pub?output=csv";
    let rawData = [];
    let currentRow = null;

    function checkPassword() {
      const password = document.getElementById("password-input").value;
      if (password === "424520") {
        document.getElementById("auth-screen").style.display = "none";
        document.getElementById("main-content").style.display = "block";
      } else {
        document.getElementById("error-msg").classList.remove("hidden");
      }
    }

    function csvToJson(csv) {
      const lines = csv.trim().split('\n');
      const headers = lines[0].split(',');
      return lines.slice(1).map(line => {
        const values = line.split(',');
        let obj = {};
        headers.forEach((h, i) => {
          obj[h.trim()] = values[i] ? values[i].trim() : '';
        });
        return obj;
      });
    }

    function loadData() {
      fetch(csvUrl)
        .then(res => res.text())
        .then(csvText => {
          rawData = csvToJson(csvText);
          renderCards(rawData);
        })
        .catch(err => {
          console.error("โหลดข้อมูลล้มเหลว", err);
          alert("โหลดข้อมูลจาก Google Sheets ไม่ได้");
        });
    }

    function renderCards(data) {
      const container = document.getElementById('card-container');
      container.innerHTML = '';
      data.forEach((row, index) => {
        const status = row["สถานะ"] || '';
        const statusColor = status === "Active" ? "bg-green-100 text-green-800" : "bg-yellow-100 text-yellow-800";
        const statusLabel = status === "Active" ? "Active" : "ยังไม่ Active";

        const card = document.createElement('div');
        card.className = "bg-white rounded-lg p-4 shadow border";
        card.innerHTML = `
          <h2 class="text-lg font-semibold mb-2">${row["รุ่น"] || '-'}</h2>
          <p><strong>สี:</strong> ${row["สี"] || '-'}</p>
          <p><strong>ร้าน:</strong> ${row["ร้าน"] || '-'}</p>
          <p><strong>IMEI:</strong> ${row["IMEI"] || '-'}</p>
          <p><strong>สถานะ:</strong> <span class="px-2 py-1 rounded text-sm ${statusColor}">${statusLabel}</span></p>
          <p><strong>หมายเหตุ:</strong> ${row["หมายเหตุ"] || '-'}</p>
          <div class="mt-3 flex gap-2 flex-wrap">
            <button onclick="copyIMEI('${row["IMEI"]}')" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 text-sm">Copy IMEI</button>
            ${status === "Active"
              ? `<button onclick="openModal(${index}, 'deactive')" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 text-sm">Deactive</button>`
              : `<button onclick="openModal(${index}, 'active')" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 text-sm">Active</button>`
            }
          </div>
        `;
        container.appendChild(card);
      });
    }

    function filterStatus(status) {
      if (status === "all") {
        renderCards(rawData);
      } else {
        renderCards(rawData.filter(row => (row["สถานะ"] || "") === status));
      }
    }

    function copyIMEI(imei) {
      navigator.clipboard.writeText(imei);
      const alert = document.getElementById('alert-box');
      alert.classList.remove('hidden');
      setTimeout(() => alert.classList.add('hidden'), 2000);
    }

    function openModal(index, action) {
      currentRow = { index, action };
      document.getElementById('remark-input').value = action === 'active' ? 'Active เอง' : 'Deactive เอง';
      document.getElementById('modal-title').innerText = action === 'active' ? 'ยืนยันการ Active' : 'ยืนยันการ Deactive';
      document.getElementById('modal').classList.remove('hidden');
    }

    function closeModal() {
      document.getElementById('modal').classList.add('hidden');
    }

    function confirmStatusChange() {
      const remark = document.getElementById('remark-input').value || '-';
      const row = rawData[currentRow.index];
      row["สถานะ"] = currentRow.action === 'active' ? 'Active' : '';
      row["หมายเหตุ"] = remark;
      renderCards(rawData);
      closeModal();
    }

    loadData();
  </script>
</body>
</html>
